手法概要：
動的閾値調整は、鋳巣を検出する際の基準値（閾値）を、画像の特徴に応じて自動的に変更する方法です。これは、固定の閾値では捉えきれない様々なサイズや深さの鋳巣を適切に検出するために使用します。

現状の手順のどこの部分なのか：
現状の手順4の改善に該当します。具体的には、"-20μmの領域を検出し、-20μm以上を検出するとNG候補となる"という部分を改良します。

2つの課題のうちどちらに対するアプローチなのか：
主に課題①（小さい鋳巣と大きい鋳巣の同時検出）に対するアプローチですが、課題②（隣接する鋳巣の判別）にも部分的に効果があります。

実装手順：
1. 画像分割:
   - 入力画像（例：2000x2000ピクセル）を100x100ピクセルの小領域に分割します。
   - 例：20x20の格子状に分割され、400の小領域ができます。
2. 統計量計算:
   各小領域で以下を計算します。
   - 平均高さ: すべてのピクセルの高さ値の合計 ÷ ピクセル数
   - 標準偏差: √[(各ピクセルの高さ - 平均高さ)^2の合計 ÷ ピクセル数]
3. 閾値決定:
   各小領域で、以下の式を使用して閾値を決定します。
   閾値 = 平均高さ - (標準偏差 * 2.5)
   例：
   - 平均高さが-10μm、標準偏差が4μmの場合
   - 閾値 = -10 - (4 * 2.5) = -20μm
4. 鋳巣検出:
   各小領域内で、計算した閾値を使用して鋳巣を検出します。
   - ピクセルの高さ < 閾値 の場合、そのピクセルを鋳巣の一部とみなします。
5. オーバーラップ処理:
   - 50ピクセルずつずらしながら、同様の処理を繰り返します。
   - これにより、150x150ピクセルの領域が生成され、中央の50x50ピクセルに最終結果を適用します。
6. 結果の統合:
   すべての小領域の結果を統合して、最終的な鋳巣検出マップを生成します。

どういう原理でこの手順で課題を解決できるのか：
こ1. ローカライゼーション：
   画像を小領域に分割することで、局所的な表面特性を捉えます。これにより、画像全体で一律の閾値を使用する場合と比べて、各領域の特徴に適した閾値を設定できます。
2. 統計的アプローチ：
   平均と標準偏差を使用することで、各領域の高さ分布を考慮した閾値を設定します。標準偏差を利用することで、領域内の高さのばらつきに応じて閾値を調整できます。
3. スケール適応性：
   小さい鋳巣が多い領域では標準偏差が小さくなり、結果として閾値が敏感（高め）に設定されます。一方、大きい鋳巣がある領域では標準偏差が大きくなり、閾値が鈍感（低め）に設定されます。これにより、異なるサイズの鋳巣を同時に検出できます。
4. 連続性の確保：
   オーバーラップ処理により、領域間の急激な閾値の変化を防ぎ、滑らかな検出結果を得ることができます。これは、隣接する鋳巣の判別にも役立ちます。
5. ノイズ耐性：
   局所的な統計量を使用することで、画像全体のノイズや照明むらの影響を軽減できます。

メリット/デメリット：
メリット：
1. 様々なサイズの鋳巣を同時に検出できる
2. 画像の局所的な特徴に適応するため、より正確な検出が可能
3. 照明条件の変化や表面の不均一性に対してロバスト
4. 人間の介入なしに自動で最適な閾値を設定できる

デメリット：
1. 計算量が増加し、処理時間が長くなる可能性がある
2. 実装が複雑になり、パラメータ調整が必要
3. 極端に大きな鋳巣がある場合、その周辺の小さな鋳巣の検出精度が低下する可能性がある
4. 領域分割のサイズや閾値計算の定数の選択によって結果が変わる可能性がある
5. 現状のシステムに大きな変更を加える必要があり、既存の処理フローとの整合性を取るのに時間がかかる可能性がある
