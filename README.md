# 5. Canny+DoGによる欠陥候補検出 (Part 1)

本セクションでは、ワークの加工領域内における鋳巣（欠陥）を検出する処理について説明する。検出は以下の2つの手法を組み合わせて実施する：

1. Cannyエッジ検出による大きな欠陥の検出
2. DoG（Difference of Gaussian）フィルタによる小さな欠陥の検出

## パラメータ調整のポイント

1. 大きな欠陥の検出
   - canny_min_threshold, canny_max_thresholdで検出感度を調整
   - texture_thresholdでテクスチャの検出感度を調整
   - canny_merge_distanceで検出結果の統合度合いを調整

2. 小さな欠陥の検出
   - bright_threshold, dark_thresholdで明暗の判定基準を調整
   - dog_ksizeとsigma_pairsで検出スケールを調整
   - min_contrast_ratioでコントラストの判定基準を調整

3. 結果の統合
   - dog_merge_distanceで検出結果の統合度合いを調整
   - モルフォロジー演算のパラメータで最終的な検出結果を調整

## Cannyエッジ検出による大きな欠陥検出

### apply_canny_detection()
大きな鋳巣を検出するための関数である。以下の処理ステップで実装されている：

1. マスク処理
   - マスク領域内の画像のみを抽出
   - 不要な領域を除外

2. 前処理
   - ガウシアンブラーによるノイズ除去
   - パラメータ：canny_kernel_size, canny_sigma

3. エッジ検出
   - Cannyエッジ検出の適用
   - パラメータ：canny_min_threshold, canny_max_threshold

4. テクスチャ検出
   - ラプラシアンフィルタによる局所的な変化の検出
   - パラメータ：texture_threshold

5. 結果の統合
   - エッジとテクスチャの結果を統合
   - 近接領域の統合（モルフォロジー演算）
   - パラメータ：canny_merge_distance

## DoGフィルタによる小さな欠陥検出

### apply_dog_filter()
DoGフィルタを適用する基本関数である：

1. 処理内容
   - 2つのガウシアンフィルタの差分を計算
   - 異なるσ値で平滑化された画像の差分を取得

2. パラメータ
   - dog_ksize：カーネルサイズ
   - dog_sigma1：1つ目のガウシアンのσ値
   - dog_sigma2：2つ目のガウシアンのσ値

### apply_dynamic_threshold()
動的閾値処理を適用する関数である：

1. 処理内容
   - 適応的閾値処理の適用
   - 局所領域ごとに最適な閾値を計算

2. パラメータ
   - dynamic_ksize：局所領域のサイズ
   - dynamic_c：閾値調整用定数
   - dynamic_method：適応的閾値処理の方法

### calculate_contrast_mask()
コントラストに基づくマスクを生成する関数である：

1. 処理手順
   - 局所的な平均値との差分を計算
   - コントラスト比の計算
   - 閾値処理によるマスク生成

2. パラメータ
   - min_contrast_ratio：最小コントラスト比
   - dynamic_ksize：局所領域のサイズ

### apply_dog_detection()
小さな鋳巣を検出するための主要な関数である：

1. 明暗領域の検出
   - bright_threshold：明るい領域の閾値
   - dark_threshold：暗い領域の閾値
   - 明暗それぞれの領域でマスクを生成

2. マルチスケールDoG処理
   - 複数のσ値の組み合わせでDoGフィルタを適用
   - 異なるスケールでの検出結果を統合
   - パラメータ：
     - dog_ksize：フィルタのカーネルサイズ
     - sigma_pairs：[(1.5, 3.5), (2.0, 4.0), (1.0, 2.5)]

3. 補助的なマスク生成
   - 動的閾値処理による二値化
   - コントラストマスクの生成
   - 勾配強度の計算

4. 結果の統合処理
   - 各種マスクの論理演算による統合
   - 近接領域の統合（モルフォロジー演算）
   - パラメータ：dog_merge_distance

### calculate_gradient_magnitude()
画像の勾配強度を計算する補助関数である：

1. 処理内容
   - Sobelフィルタによる勾配計算（x方向、y方向）
   - 勾配の大きさを計算
   - 0-255の範囲に正規化

## 統合処理

### detect_defects()
CannyとDoGの検出結果を統合する関数である：

1. 処理手順
   - 大きな欠陥の検出（Canny）
   - 小さな欠陥の検出（DoG）
   - 両結果の論理和による統合

### process_images()
画像群に対して一括で欠陥検出を実行する関数である：

1. 実行内容
   - 各画像に対して欠陥検出を実行
   - 検出結果をリストとして保持
   - メモリ使用量を考慮した分割処理

## 可視化

### visualize_defect_detection()
検出結果を可視化する関数である：

1. 表示内容
   - 元の撮影画像
   - Cannyによる大きな欠陥の検出結果
   - DoGによる小さな欠陥の検出結果
   - 両者を統合した最終結果

2. 表示形式
   - 2×2のサブプロット構成
   - グレースケールでの表示
   - ファイル名をタイトルとして表示

