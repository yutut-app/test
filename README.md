# 8. 欠陥候補の画像とCSV保存

本セクションでは、検出された欠陥候補の画像データとその特徴量をファイルとして保存する処理について説明する。

## 関数の詳細説明

### extract_roi()
画像から欠陥領域を切り出す関数である：

1. 処理内容
   - 欠陥情報に基づく切り出し範囲の計算
   - 余白（margin）の追加
   - 画像境界のチェック

2. 特徴
   - 画像の境界を超えない範囲で切り出し
   - marginパラメータによる余白の調整

### save_defect_roi()
切り出した欠陥領域を画像ファイルとして保存する関数である：

1. 処理手順
   - 欠陥領域の切り出し
   - 必要に応じた画像の拡大
   - PNG形式での保存

2. パラメータ
   - enlargement_factor：保存時の拡大倍率

### create_defect_info()
欠陥情報を辞書形式で作成する関数である：

1. 記録情報
   - 元画像情報：画像名、タイプ（NG/OK）
   - 欠陥画像情報：ファイル名、保存パス
   - ラベル情報：画像ラベル、欠陥ラベル
   - 欠陥特徴量：検出された全特徴量

### save_defects()
欠陥検出結果を一括で保存する関数である：

1. ディレクトリ構造
   ```
   output_dir/
   ├── ng/
   │   └── [画像名]/
   │       ├── edge/     # エッジ画像
   │       └── original/ # 元画像の切り出し
   └── ok/
       └── [画像名]/
           ├── edge/
           └── original/
   ```

2. 保存内容
   - エッジ画像：検出結果の可視化用
   - オリジナル画像：欠陥の実態確認用
   - 欠陥情報：特徴量などのメタデータ

### save_to_csv()
欠陥情報をCSVファイルとして保存する関数である：

1. 保存形式
   - 欠陥情報を pandas DataFrameに変換
   - CSVファイルとして保存

2. 保存モード
   - 新規作成：ファイルが存在しない場合
   - 追記：既存ファイルがある場合

## 実行時の処理フロー

1. 出力ディレクトリの作成
   - defect_images：欠陥画像保存用
   - defect_data：CSV保存用

2. 欠陥候補の保存
   - NGデータの処理（image_label=1）
   - OKデータの処理（image_label=0）
   - 画像とメタデータの保存

3. CSVファイルの生成
   - 全欠陥情報の統合
   - CSVファイルへの保存

## パラメータ調整のポイント

1. 画像保存関連
   - enlargement_factor：保存時の拡大倍率
   - margin：切り出し時の余白サイズ

2. ファイル構成
   - output_data_dir：基本出力ディレクトリ
   - ディレクトリ構造の設計

これらのパラメータは、後続の分析や検証作業の要件に応じて適切に調整する必要がある。
