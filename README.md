以下は、未経験者でも見ただけでコードの目的や処理内容が理解できるように、各ステップをさらに詳細に説明したものです。各項目の処理目的や流れを、初心者にわかりやすく説明しています。これにより、.ipynbを初めて見る人でもプロジェクト全体を把握できるようにしました。

---

# Table of Contents
1. [ライブラリのインポート](#ライブラリのインポート)
2. [パラメータの設定](#パラメータの設定)
3. [データの読み込み](#データの読み込み)
4. [ワーク接合部の削除](#ワーク接合部の削除)
5. [二直化によるマスクの作成](#二直化によるマスクの作成)
6. [エッジ検出とテクスチャ検出の改良](#エッジ検出とテクスチャ検出の改良)
7. [ラベリング処理と欠陥候補の中心座標の取得](#ラベリング処理と欠陥候補の中心座標の取得)
8. [ワークのエッジと重なっている欠陥候補の除外処理](#ワークのエッジと重なっている欠陥候補の除外処理)
9. [欠陥候補の保存（外接矩形を切り出し、100倍に拡大）](#欠陥候補の保存)

---

## 1. ライブラリのインポート
### 目的:
画像処理、数値計算、結果表示、ファイル操作などを実行するために必要なライブラリをインポートします。これらのライブラリはプロジェクト全体で使用される重要なツールであり、特に画像の読み込み、加工、保存に関与します。

### 詳細な説明:
- **os**: ディレクトリ操作やファイルパスの管理に使用します。例えば、画像を読み込む際にディレクトリを指定したり、結果を保存する際に使います。
- **cv2 (OpenCV)**: OpenCVは画像処理に特化したライブラリです。テンプレートマッチング（画像同士を比較して類似性を検出する）やエッジ検出（画像の輪郭を抽出する）、画像の加工や表示に使用します。
- **numpy**: 数値計算や画像データの処理に使用します。画像データは行列として扱われるため、numpyを使って配列操作を行います。
- **skimage (Scikit-image)**: 高度な画像処理ライブラリです。画像の二直化（バイナリ化）やフィルタリング、エッジ検出などを簡単に行えます。
- **matplotlib**: 処理結果の画像を表示するために使います。画像を視覚的に確認する際に役立ちます。

---

## 2. パラメータの設定
### 目的:
ここでは、画像処理に必要なパラメータを設定します。しきい値やカーネルサイズなどの数値を調整することで、後のステップでの画像処理結果を制御します。

### 詳細な説明:
- **input_data_dir**: このプロジェクトで処理する画像が保存されているフォルダのパスを指定します。NG画像（不良品の画像）とOK画像（良品の画像）がこのフォルダに入っています。
- **output_data_dir**: 処理した結果や欠陥候補を保存するフォルダです。処理が終わった後、このフォルダに欠陥部分を切り出して保存します。
- **ng_labels**: NG（不良品）画像のラベルです。ラベル1は「鋳巣」、ラベル2は「凹み」、ラベル3は「亀裂」を表します。これにより、NGデータを分類して管理します。
- **crop_width**: ワーク（画像中の部品）の接合部を削除するための幅です。接合部は不要な領域なので、この幅を基準に削除します。
- **threshold_value**: 二直化（バイナリ化）を行う際のしきい値です。この値よりも大きい部分は白、小さい部分は黒に変換されます。これにより、H面（部品表面）を検出します。
- **kernel_size**: 画像を処理する際に使用するフィルタのサイズです。主にノイズ除去や画像の平滑化に使います。
- **gaussian_kernel_size**: ガウシアンブラーに使うカーネルのサイズです。画像をぼかすことで、エッジ検出前のノイズを減らします。
- **canny_min_threshold/canny_max_threshold**: Cannyエッジ検出に使用するしきい値です。エッジ検出は画像中の輪郭や欠陥部分を見つけるために行われますが、このしきい値でどの部分をエッジとして認識するかを制御します。
- **sigma**: ガウシアンフィルタのぼかし具合を制御するパラメータです。値を大きくすると、画像がよりぼやけます。
- **min_defect_size/max_defect_size**: 検出する欠陥の最小・最大サイズです。小さすぎる欠陥や大きすぎる欠陥は除外し、適切な範囲の欠陥だけを検出します。

---

## 3. データの読み込み
### 目的:
ここでは、指定したフォルダから画像を読み込みます。NG画像とOK画像をそれぞれペアにして、後の処理に使えるように準備します。

### 詳細な説明:
- **元画像 (Normal)** と **キーエンス前処理画像 (Shape)** を読み込み、ペアとして管理します。元画像は部品のオリジナルの状態を、キーエンス前処理画像は不良品検出のために加工された画像を指します。
- ディレクトリ内の画像ファイル名を調べ、`Normal`を含むファイルは元画像、`Shape`を含むファイルはキーエンス前処理画像としてペアにします。
- 画像を読み込む際にNG画像とOK画像を区別し、それぞれのリストにまとめて保存します。これにより、後の処理でNGデータとOKデータを効率的に扱えるようにします。

---

## 4. ワーク接合部の削除
### 目的:
ワーク（画像内の部品）の接合部は欠陥検出の対象外です。このステップでは、部品の接合部分を削除して、対象領域をH面（表面部分）に限定します。

### 詳細な説明:
- **テンプレートマッチング**: 部品の右側か左側かを判定するために、テンプレートマッチングを使用します。部品の右側や左側の特徴を持つテンプレート画像と比較し、画像がどちら側かを判断します。
- **接合部の削除**: 判定された右側か左側の画像から接合部を削除します。右側の画像であれば左から1360ピクセルをカットし、左側の画像であれば右からカットします。これにより、接合部が除外され、H面の領域だけが残ります。

---

## 5. 二直化によるマスクの作成
### 目的:
このステップでは、元画像を二直化（バイナリ化）してH面をマスクします。これにより、部品表面の欠陥が見つけやすくなります。

### 詳細な説明:
- **グレースケール変換**: 元画像がカラーの場合、まずグレースケールに変換します。これにより、各ピクセルが0～255の範囲の明るさに変換されます。
- **二直化（バイナリ化）**: グレースケール画像に対してしきい値を設定し、明るさがしきい値より高い部分を白、低い部分を黒に変換します。これにより、部品のH面（表面）が白く表示され、背景が黒く表示されます。
- **膨張・収縮処理**: バイナリ化後にカーネル（フィルタ）を使って画像を膨張させたり収縮させたり

します。これにより、小さなノイズを除去し、H面の形状を整えます。

---

## 6. エッジ検出とテクスチャ検出の改良
### 目的:
エッジ検出に加えて、テクスチャの変化を検出することで、通常のエッジ検出では見逃されがちな小さな欠陥も検出できるようにします。

### 詳細な説明:
- **ガウシアンブラー**: まず、画像全体にぼかしを適用してノイズを除去します。ノイズが残っていると、エッジ検出時に誤検出が発生する可能性があります。
- **Cannyエッジ検出**: ぼかした後、Cannyエッジ検出を使用して画像中のエッジ（輪郭）を検出します。このエッジが欠陥の候補となります。
- **ラプラシアンフィルタ**: エッジ検出では検出できないような小さなテクスチャの変化を見つけるために、ラプラシアンフィルタを使用します。これにより、H面上のわずかな欠陥も検出されます。
- **エッジとテクスチャの統合**: 最後に、Cannyエッジ検出の結果とラプラシアンフィルタの結果を統合して、最終的な欠陥候補を得ます。

---

## 7. ラベリング処理と欠陥候補の中心座標の取得
### 目的:
検出されたエッジやテクスチャをラベリングし、欠陥候補のサイズと中心座標を特定します。

### 詳細な説明:
- **ラベリング処理**: OpenCVの`cv2.connectedComponentsWithStats`関数を使って、エッジやテクスチャの連続領域にラベルを付けます。これにより、個別の欠陥候補が識別されます。
- **欠陥サイズのフィルタリング**: ラベリングされた欠陥のサイズを確認し、指定された最小サイズ（例えば0.5mm相当）より小さいものや、最大サイズ（10mm相当）より大きいものは除外します。これにより、適切な大きさの欠陥だけを検出できます。
- **中心座標の取得**: 各欠陥の重心（中心座標）を計算し、その位置情報を取得します。この座標は後のステップで欠陥部分を表示したり保存する際に使用します。

---

## 8. ワークのエッジと重なっている欠陥候補の除外処理
### 目的:
ワークのエッジ（H面の外周）が欠陥として誤検出されないように、エッジ部分に重なっている欠陥候補を除外します。

### 詳細な説明:
- **マスクエッジの検出**: Cannyエッジ検出を使用して、マスクのエッジ（H面の外周）を検出します。これは欠陥ではない部分なので、欠陥候補から除外する必要があります。
- **エッジに重なっている欠陥の除外**: マスクエッジに重なっている欠陥候補がないか確認し、重なっている場合はその欠陥候補を除外します。これにより、誤検出が防がれます。
- **マージンの設定**: マスクのエッジが細い場合に備えて、エッジにマージン（余裕）を持たせます。これにより、エッジと欠陥候補の重なりがより正確に検出されます。

---

## 9. 欠陥候補の保存（外接矩形を切り出し、100倍に拡大）
### 目的:
検出された欠陥候補を外接矩形で切り出し、100倍に拡大して保存します。これにより、欠陥部分を詳細に確認できるようにします。

### 詳細な説明:
- **欠陥の切り出し**: 検出された欠陥候補を囲む外接矩形を使って、その欠陥部分を切り出します。これにより、欠陥部分だけを抽出します。
- **100倍に拡大**: 切り出した欠陥部分を100倍に拡大します。これは、欠陥を詳細に分析したり確認したりする際に役立ちます。
- **画像の保存**: 拡大した欠陥画像を指定されたフォルダに保存します。保存先は、元画像ごとに整理されており、欠陥ごとに異なるファイル名で保存されます。

---

これにより、未経験者や初心者でもコードがどのような処理を行っているのかを詳細に理解できるようになりました。.ipynbファイルを読むだけで、プロジェクトの全体像や各ステップの役割が分かりやすくなっています。
