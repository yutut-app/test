# 2. パラメータの設定

本システムを使用するにあたっての重要な前提条件と各パラメータの設定について説明する。

## 前提条件

1. データ配置
   - input_dataディレクトリに指定された構造で画像を配置する必要がある
   - テンプレート画像は事前に以下のディレクトリに配置する必要がある
     - left_right_judge_template：左右判定用テンプレート
     - mask_template：マスク生成用テンプレート

2. メモリ使用量の考慮
   - OKの撮影画像はNo1~No20まで50ワークごとに分割
   - メモリ不足防止のため、処理ごとに手動でファイルを指定

## パラメータ説明 (基本設定)

### 1. ディレクトリとファイルパス
- `input_data_dir`：入力データのルートディレクトリ
- `output_data_dir`：出力データの保存先
- `left_right_judge_template_dir`：左右判定用テンプレートの格納先
- `mask_template_dir`：マスク用テンプレートの格納先

### 2. 左右判断用テンプレートファイルパス
- `right_judge_template_path`：右側画像判定用テンプレート
- `left_judge_template_path`：左側画像判定用テンプレート

### 3. マスク用テンプレートファイルパス
- `right_mask_template_path`：右側マスク用テンプレート
- `left_mask_template_path`：左側マスク用テンプレート

### 4. ラベル定義
- `ng_labels`：
  - 現在は'label1'（鋳巣）のみ実装
  - 未実装：label2（凹み）, label3（亀裂）
- `ok_labels`：
  - 'No1'~'No20'の範囲で指定
  - メモリ使用量を考慮して50ワークごとに分割
  - 処理ごとに手動で設定が必要

### 5. 円検出パラメータ
- `circle_dp`：
  - 分解能の逆比（1.0が標準）
  - 大きくすると検出感度が下がり、誤検出が減少
  - 小さくすると検出感度が上がるが、処理時間が増加
  - 調整範囲：0.5~2.0

- `circle_min_dist`：
  - 検出される円の中心間の最小距離（ピクセル）
  - 近接した円の分離度合いを調整
  - 値が小さいと近接した円も個別に検出
  - 調整範囲：10~50

### 5. 円検出パラメータ（続き）
- `circle_param1`：
  - Cannyエッジ検出の高閾値
  - 高いほどエッジの検出が厳密になる
  - 調整範囲：30~100

- `circle_param2`：
  - 円検出の閾値
  - 小さいほど誤検出が増える
  - 調整範囲：20~50

- `circle_min_radius`, `circle_max_radius`：
  - 検出する円の半径範囲（ピクセル）
  - ワークの実際のサイズに応じて調整
  - 調整範囲：min（5~20）, max（80~150）

### 6. テンプレートマッチングパラメータ
- `template_match_threshold`：
  - マッチング判定の閾値（0-1）
  - 大きいほど厳密なマッチングを要求
  - 調整範囲：0.7~0.9

### 7. スケール調整パラメータ
- `scale_min`, `scale_max`：
  - スケール変換の範囲
  - 画像サイズのばらつきに対応
  - 調整範囲：min（0.7~0.9）, max（1.1~1.3）

- `scale_step`：
  - スケール調整の刻み幅
  - 小さいほど精密だが処理時間が増加
  - 調整範囲：0.05~0.2

### 8. Cannyエッジ検出パラメータ（大きな欠陥用）
- `canny_kernel_size`：
  - ガウシアンフィルタのカーネルサイズ
  - 大きいほどノイズ除去効果が強い
  - 奇数値のみ設定可能：(3,3)~(7,7)

- `canny_sigma`：
  - ガウシアンフィルタのシグマ値
  - 大きいほど平滑化効果が強い
  - 調整範囲：1.0~3.0

- `canny_min_threshold`, `canny_max_threshold`：
  - Cannyエッジ検出の閾値範囲
  - 欠陥のエッジ強度に応じて調整
  - 調整範囲：min（30~80）, max（200~300）

- `canny_merge_distance`：
  - Canny検出結果の統合距離
  - 近接したエッジの結合度合いを制御
  - 調整範囲：10~20

- `texture_threshold`：
  - テクスチャ検出用閾値
  - 表面テクスチャの影響を制御
  - 調整範囲：20~40

### 9. DoGフィルタパラメータ（小さな欠陥用）
- `dog_ksize`：
  - DoGフィルタのカーネルサイズ
  - 奇数値のみ設定可能
  - 大きいほど広範囲の特徴を検出
  - 調整範囲：5~13

- `dog_sigma1`, `dog_sigma2`：
  - ガウシアンフィルタのシグマ値
  - sigma2 > sigma1となるように設定
  - 調整範囲：
    - sigma1：1.0~2.0
    - sigma2：3.0~4.0

- `dog_merge_distance`：
  - DoG検出結果の統合距離
  - 近接した検出結果の結合度合い
  - 調整範囲：10~20

### 10. 動的閾値処理パラメータ
- `dynamic_ksize`：
  - 局所領域のサイズ
  - 奇数値のみ設定可能
  - 調整範囲：15~35

- `dynamic_c`：
  - 閾値調整用定数
  - 大きいほど検出が厳密になる
  - 調整範囲：4~8

### 11. 欠陥サイズパラメータ
- 大きな欠陥：
  - `min_large_defect_size`：40~80
  - `max_large_defect_size`：80~120

- 小さな欠陥：
  - `min_small_defect_size`：3~7
  - `max_small_defect_size`：40~80

### 12. エッジ補完パラメータ
- `edge_kernel_size`：
  - エッジ補完のカーネルサイズ
  - 奇数値のみ設定可能
  - 調整範囲：(3,3)~(5,5)

- `edge_open_iterations`：
  - ノイズ除去の繰り返し回数
  - 調整範囲：1~3

- `edge_close_iterations`：
  - エッジ補完の繰り返し回数
  - 調整範囲：8~12

### 13. マスクエッジ検出パラメータ
- `mask_edge_min_threshold`：30~70
- `mask_edge_max_threshold`：130~170
- `mask_edge_margin`：8~12

### 14. コントラストと輝度パラメータ
- `min_contrast_ratio`：0.1~0.15
- `min_intensity_diff`：20~30
- `bright_threshold`：160~200
- `dark_threshold`：30~70

### 15. ファイル出力パラメータ
- `enlargement_factor`：
  - 基本的に1に設定
  - 資料作成用の場合のみ変更可能
  - 調整範囲：1~4

パラメータの調整は、以下の手順で行うことを推奨：
1. 基本パラメータ（円検出、テンプレートマッチング）の調整
2. 欠陥検出パラメータ（Canny、DoG）の調整
3. サイズとフィルタリングパラメータの調整
4. 必要に応じて細かいパラメータの微調整
