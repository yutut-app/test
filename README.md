Isolation Forestのフローを初学者向けに詳しく説明する。具体的なパラメータや設定値、手法も含める。

1. [`データ前処理`]
   - 特徴量の設定: 分析に使用する特徴（例：幅、高さ、面積など）を選択する。
   - ワークごとのデータ集約: 同じワークID内のデータをグループ化する。

2. [`特徴空間の準備`]
   - 特徴量（X）の抽出: 選択した特徴量のみをデータフレームから抽出する。
   - 異常スコア計算用のデータセット作成: 抽出した特徴量を使用してデータセットを作成する。

3. [`アノマリー比率の設定`]
   - contamination パラメータの設定: データセット内の予想される異常データの割合を指定する。例えば、0.003（0.3%）に設定する。
   - この値は、データセットの特性や過去の経験に基づいて決定する。

4. [`モデル構築`]
   - Isolation Forest のハイパーパラメータ設定:
     - n_estimators: 決定木の数（例：100）
     - max_features: 各決定木で使用する特徴量の数（例：1）
     - random_state: 再現性のための乱数シード（例：42）
   - モデルの学習と予測の同時実行: fit_predict() メソッドを使用して、データの学習と異常の予測を同時に行う。

5. [`異常スコアの算出`]
   - 各データポイントの異常度スコアの計算: score_samples() メソッドを使用して計算する。
   - 閾値（decision function）の決定: モデルが自動的に決定する閾値を使用する。

6. [`モデル評価`]
   - 予測ラベルと真のラベルの比較: モデルの予測結果と実際のラベルを比較する。
   - 混同行列の作成: TP（真陽性）、FP（偽陽性）、TN（真陰性）、FN（偽陰性）を計算する。
   - 評価指標の計算:
     - 見逃し率 = FN / (FN + TP)
     - 誤検出率 = FP / (FP + TN)
     - 正解率 = (TP + TN) / 総データ数
   - ワークレベルでの予測と評価: 各ワーク内で1つでも異常と判定されたら、そのワーク全体を異常と判定する。

7. [`結果分析`]
   - 特徴量と異常スコアの相関分析: 各特徴量と計算された異常スコアの相関係数を計算する。
   - 性能指標の解釈: 計算された評価指標を基に、モデルの性能を判断する。
   - モデルの改善点の検討: 性能が不十分な場合、パラメータの調整や特徴量の選択を再検討する。

このフローは、Isolation Forestを使用した異常検知の基本的なプロセスを示す。各ステップで適切なパラメータや手法を選択することで、効果的な異常検知モデルを構築できる。
