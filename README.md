# 9. 欠陥候補の画像の保存とCSV出力

このセクションでは、検出された欠陥候補の画像を保存し、その特徴量をCSVファイルとして出力します。

1. `save_defect_image`関数
  - 目的：検出された欠陥候補部分の画像を切り出して保存
  - 処理の流れ：
    * 切り出し範囲の決定：欠陥の中心から最大サイズ分の領域を指定
    * エッジ画像の保存：
      - 欠陥部分のエッジ画像を切り出し
      - 指定倍率で拡大
      - edge/フォルダに保存
    * オリジナル画像の保存：
      - 同じ位置の元画像を切り出し
      - 同じ倍率で拡大
      - original/フォルダに保存
    * 両方の保存パスを返す

2. `get_original_image`関数
  - 目的：ファイル名に対応するオリジナル画像を取得
  - 処理内容：
    * 二値化画像リストから対応する元画像を検索
    * 見つかった場合はその画像を返す
    * 見つからない場合はNoneを返す

3. `process_images_for_saving`関数
  - 目的：全ての欠陥候補の画像保存とデータ集約
  - 処理の流れ：
    * 出力ディレクトリ作成：
      - NG/OKごとのディレクトリ
      - 画像ごとのサブディレクトリ
      - edge/originalの区別用ディレクトリ
    * 欠陥候補の保存：
      - 各欠陥候補の画像を切り出して保存
      - 特徴量データの収集
      - パス情報の記録
    * データの構造化：
      - 画像名（元の画像ファイル名）
      - 切り出し画像名（defect_X.png）
      - エッジ画像パス
      - オリジナル画像パス
      - 欠陥ラベル
      - 検出手法
      - 各種特徴量

4. メイン処理部分
  - 実行手順：
    * 出力ディレクトリの作成
    * NG/OK画像それぞれの処理
    * 全データの集約
    * CSVファイルの出力：
      - 既存ファイルがある場合：追記モード（ヘッダーなし）
      - 新規作成の場合：ヘッダー付きで保存

5. 出力ファイル構造
  - ディレクトリ構造：
    ```
    defect_images/
        ng/
            image_name/
                edge/
                    defect_1.png
                    defect_2.png
                    ...
                original/
                    defect_1.png
                    defect_2.png
                    ...
        ok/
            ...
    defect_data/
        defects_data.csv
    ```
  - CSVファイルの主な列：
    * image_name：元画像のファイル名
    * defect_image_name：切り出した画像のファイル名
    * defect_image_edge_path：エッジ画像の保存パス
    * defect_image_original_path：オリジナル画像の保存パス
    * Image_label：欠陥の有無（0:OK, 1:NG）
    * detection_method：検出手法（canny/dog）
    * その他の特徴量（面積、周囲長など）
