# 4. 加工領域の特定

本セクションでは、ワークの撮影画像から加工領域を特定する処理について説明する。この処理は以下の手順で実行される：

1. 撮影画像の向き判定（左右どちらの撮影画像か）
2. 画像内の円の検出
3. テンプレートとの位置合わせ
4. 加工領域のマスク生成

## 関数の詳細説明

### detect_circles()

画像から円を検出する関数である。

1. 実装内容
   - OpenCVのHoughCircles関数を使用
   - 画像内の円を検出し、中心座標(x, y)と半径(r)を取得

2. パラメータ調整のポイント
   - circle_dpで検出感度を調整（値が大きいほど感度が下がる）
   - circle_min_dist, circle_min_radius, circle_max_radiusで円のサイズや間隔を制限
   - circle_param1, circle_param2で検出精度と誤検出のバランスを調整

### determine_image_orientation()

撮影画像の向き（左右どちらを撮影した画像か）を判定する関数である。

1. 判定方法
   - テンプレートマッチング（cv2.TM_CCOEFF_NORMED）を使用
   - 左右それぞれのテンプレートとのマッチング度を計算
   - より高いマッチング度を示した方を撮影方向として判定

2. 判定の特徴
   - 正規化相関係数を使用することで照明条件の影響を軽減
   - template_match_thresholdでマッチングの閾値を調整可能

### get_optimal_scale_and_transform()

テンプレートと対象画像の位置合わせのためのスケールと変換行列を計算する関数である。

1. 計算プロセス
   - テンプレートと対象画像の円の位置情報を使用
   - スケールを変化させながら最適な位置合わせを探索
   - アフィン変換行列を計算

2. パラメータ調整のポイント
   - scale_min, scale_maxでスケールの探索範囲を設定
   - scale_stepでスケールの探索精度を調整

### create_processing_area_mask()

加工領域のマスクを生成する関数である。

1. 処理手順
   - 画像の向きを判定
   - 適切なマスクテンプレートを選択
   - テンプレートを対象画像に合わせて変形
   - マスク画像を生成

2. 特徴
   - 円検出に失敗した場合は全領域をマスク対象とする
   - テンプレートの反転処理により、加工領域を白で表現

### process_images()

画像群に対して一括で加工領域の検出を行う関数である。

1. 処理内容
   - Shape画像の読み込み
   - 加工領域のマスク生成
   - 処理結果をリストとして保持

2. 実行時の注意点
   - メモリ使用量を考慮し、OKワークは分割して処理する
   - processed_ng_images, processed_ok_imagesとして結果を保持

## 可視化関数

### visualize_processed_images()

処理結果を可視化する関数である。

1. 表示内容
   - 元の撮影画像
   - 生成されたマスク
   - マスクを適用した結果

2. 表示形式
   - 1枚の画像につき3つのサブプロットで表示
   - グレースケールで表示
   - ファイル名をタイトルとして表示
