.ipynbファイル内で、誰が見てもコードの動作を理解できるように、さらに詳細に説明します。各項目について、目的や処理内容を詳しく記述し、処理の流れやステップごとの意図を明確にします。

以下に、各項目の詳細な説明を示します。

---

### 目次 (Table of Contents)

1. ライブラリのインポート
2. パラメータの設定
3. データの読み込み
4. ワーク接合部の削除
5. 元画像からワークのH面領域を検出
    5.1 二直化によるマスクの作成
6. キーエンス前処理画像から欠陥候補を検出
    6.1 エッジ検出とテクスチャ検出の改良
    6.2 ラベリング処理
    6.3 欠陥候補の中心座標の取得
7. 欠陥候補の表示
8. ワークのエッジと重なっている欠陥候補の除外
9. 欠陥候補の保存

---

### 1. ライブラリのインポート

**目的**:
このセクションでは、Pythonで画像処理や数値計算、データの可視化を行うために必要なライブラリをインポートします。これらのライブラリは、後の画像処理や欠陥検出の各ステップで使用されます。

- **`os`**: ディレクトリ操作やファイルパスの管理に使用します。これにより、画像の読み込みや保存の際にファイルパスを柔軟に操作できます。
- **`cv2`（OpenCV）**: 画像の読み込み、加工、エッジ検出、欠陥の切り出しなど、画像処理のほとんどの機能を提供します。
- **`numpy`**: 画像や数値データの操作、配列計算に必要なライブラリです。大規模なデータ操作を効率的に行えます。
- **`skimage`**: 画像処理や解析をサポートするライブラリで、主にスケール変換、フィルタリング、エッジ検出に使用します。
- **`matplotlib.pyplot`**: 画像の可視化に使用します。各ステップの結果を確認するために、画像を表示する役割を果たします。

---

### 2. パラメータの設定

**目的**:
ここでは、欠陥検出の各ステップで使用するパラメータを設定します。パラメータは、実際のデータに基づいて適宜調整できるようになっており、特定の画像処理やエッジ検出の効果を左右する重要な要素です。

**設定するパラメータ**:
- **`input_data_dir`**: 入力画像が格納されているディレクトリのパス。ここからOKデータやNGデータを読み込みます。
- **`output_data_dir`**: 処理後の画像や欠陥候補を保存するディレクトリのパス。
- **`ng_labels`**: NG画像のラベル。各ラベルには、鋳巣、凹み、亀裂の3種類があります。
- **`right_template_path` と `left_template_path`**: ワークの左右を判定するためのテンプレート画像のパス。
- **`crop_width`**: ワークの接合部を削除する際に、左右からどれだけの幅をカットするかを設定する値。
- **`threshold_value`**: 画像の二直化（白黒に変換）を行う際のしきい値。
- **`kernel_size`**: エッジ検出やノイズ除去のために使用するカーネル（フィルタ）のサイズ。
- **`iterations_open` と `iterations_close`**: 膨張・収縮処理を行う回数で、画像のノイズ除去やマスクの生成に使用します。
- **`gaussian_kernel_size` と `sigma`**: 画像の平滑化（ノイズを減らす）ために使用するガウシアンブラーのカーネルサイズと標準偏差。
- **`canny_min_threshold` と `canny_max_threshold`**: エッジ検出の際に使用するCannyエッジ検出のしきい値。これにより、画像から際立ったエッジ（境界線）を検出します。
- **`min_defect_size` と `max_defect_size`**: 検出する欠陥のサイズ範囲。小さすぎる欠陥や大きすぎる欠陥は除外されます。
- **`edge_margin`**: ワークのエッジ（マスクの白い部分）と欠陥候補が重ならないようにするための余裕の設定。この値はピクセル単位で指定します。

---

### 3. データの読み込み

**目的**:
元画像とキーエンス前処理画像をペアで読み込みます。ここで読み込んだ画像データは、以降の処理（欠陥検出や分類）のベースとなります。

- **OKデータ**と**NGデータ**の読み込みを行い、NGデータは3つのラベル（鋳巣、凹み、亀裂）に分類されます。
- 各画像のペアは、元画像（Normal）とキーエンス前処理画像（Shape）という2つの異なる画像ファイルから構成されています。これらを同時に処理することで、正確な欠陥検出を行います。

---

### 4. ワーク接合部の削除

**目的**:
ワーク画像の不要な部分である接合部を削除し、H面（欠陥検出を行う対象部分）のみを対象とする画像を作成します。

- **テンプレートマッチング**を使用して、ワークが左右どちら側の画像であるかを判定します。左右が判定されたら、接合部を削除する処理を行います。
- この段階では、OKデータとNGデータに対してすべて同じ処理が適用され、処理時間の短縮やメモリの効率化を考慮しています。

---

### 5. 元画像からワークのH面領域を検出

**目的**:
元画像の中から、H面と呼ばれる欠陥検出対象の領域を正確に抽出します。H面以外の部分を除去することで、余計な情報を排除し、欠陥検出の精度を向上させます。

---

#### 5.1 二直化によるマスクの作成

**目的**:
H面の領域を白黒の二値画像（マスク）として作成します。このマスクは、後のエッジ検出や欠陥候補の抽出のために使われ、H面以外の部分を除外します。

- **二直化処理**では、画像全体の輝度値に基づいて、しきい値を超える部分を白、そうでない部分を黒に変換します。
- マスクは後の処理で使われ、H面の範囲を明確に定義するために用いられます。

---

### 6. キーエンス前処理画像から欠陥候補を検出

**目的**:
キーエンス前処理された画像から欠陥の候補となる部分を特定します。エッジ検出だけではなく、テクスチャの変化も検出することで、より多様な欠陥を見つけることができます。

---

#### 6.1 エッジ検出とテクスチャ検出の改良

**目的**:
エッジ検出では検出が難しい欠陥を見逃さないよう、テクスチャの変化を併用して欠陥候補を検出します。

- **エッジ検出**では、Cannyエッジ検出を用いて画像中の際立った境界線（エッジ）を見つけ出します。
- **テクスチャ検出**では、ラプラシアンフィルタを用いて局所的な輝度やテクスチャの変化を検出します。これにより、高さの変化がない欠陥やエッジ検出では捉えられない欠陥も見つけることが

可能になります。

---

#### 6.2 ラベリング処理

**目的**:
エッジ検出およびテクスチャ検出の結果に基づいて、欠陥候補をラベリングします。それぞれの欠陥にラベルを付け、どこに欠陥があるか、欠陥の大きさはどのくらいかを特定します。

- ラベリング処理により、画像中の連続した欠陥候補の領域をひとつの欠陥として認識します。
- **サイズフィルタリング**では、欠陥の大きさが指定された範囲内であるかどうかを確認し、範囲外の欠陥は除外されます。

---

#### 6.3 欠陥候補の中心座標の取得

**目的**:
検出された欠陥候補の中心座標を計算し、その座標を後の処理で利用できるようにします。また、外接矩形を使って欠陥の大きさを計測します。

- 欠陥の中心座標は、後に画像を切り出して保存する際に利用されます。

---

### 7. 欠陥候補の表示

**目的**:
検出された欠陥候補を赤枠で表示し、画像中でどこに欠陥があるかを視覚的に確認します。これにより、欠陥の検出結果を目視で確認でき、精度を評価する際に役立ちます。

---

### 8. ワークのエッジと重なっている欠陥候補の除外

**目的**:
ワークのエッジ（マスクの白い部分）は、欠陥として誤認識される可能性があるため、エッジと重なっている欠陥候補を除外します。エッジ部分に余裕（マージン）を持たせて除外することで、誤差を減らします。

- **エッジと重なるかの確認**には、エッジ検出したマスクを用います。その後、マスクエッジに重なっている欠陥候補はすべて削除されます。

---

### 9. 欠陥候補の保存

**目的**:
検出された欠陥候補を外接矩形で切り出し、さらに100倍に拡大して保存します。この処理は、欠陥の詳細な検証や確認を行うための重要なステップです。

- 保存先として指定されたディレクトリ内に `defect_candidate` フォルダを作成し、各画像ごとに欠陥候補を保存します。
- 欠陥候補は、外接矩形で切り出した後に100倍に拡大し、より詳細に確認できるようにします。

---

この説明により、誰が見ても各ステップで何が行われているかが明確に理解できるようになります。処理の目的、使用されている技術、設定するパラメータについても十分に理解できるように記載しました。
