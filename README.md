# 8. 欠陥候補の画像の保存とCSV出力

## 目的
検出された欠陥候補について、切り出し画像の保存とCSVデータの出力を行う。これにより、後続の分析や機械学習のための教師データを作成する。

## 処理手順
1. ディレクトリ構造の作成
2. 欠陥候補領域の切り出し
3. 画像の保存（エッジ画像とオリジナル画像）
4. 特徴量データのCSV出力

## 関数の詳細説明

### save_defect_image()
欠陥候補領域の画像を保存する関数：

1. 切り出し領域の決定
   - 中心点：centroid_x, centroid_y
   - サイズ：最大辺長を基準
   - 画像境界のチェック

2. 画像の保存
   - エッジ画像の保存
   - オリジナル画像の保存
   - 拡大処理（enlargement_factor使用）

### get_original_image()
元画像を取得する補助関数：

1. 処理内容
   - ファイル名による画像の検索
   - 対応する元画像の取得
   - エラー時のハンドリング

### process_images_for_saving()
画像群の保存処理を実行する主要関数：

1. ディレクトリ作成
   ```
   output_dir/
   ├── ng/
   │   └── [画像名]/
   │       ├── edge/     # エッジ画像
   │       └── original/ # 元画像
   └── ok/
       └── [画像名]/
           ├── edge/
           └── original/
   ```

2. 欠陥データの作成
   - 画像情報（ファイル名、パス）
   - ラベル情報（画像ラベル、欠陥ラベル）
   - 特徴量情報（位置、サイズなど）

## CSVデータの出力

1. 出力内容
   - 画像関連情報
     - image_name：元画像名
     - defect_image_name：切り出し画像名
     - defect_image_edge_path：エッジ画像パス
     - defect_image_original_path：元画像パス
   
   - ラベル情報
     - Image_label：画像ラベル（NG=1, OK=0）
     - defect_label：欠陥ラベル
     - detection_method：検出手法

   - 特徴量情報
     - 位置情報（x, y, centroid_x, centroid_y）
     - サイズ情報（width, height, area）
     - 形状特徴量（perimeter, eccentricity等）

2. 出力モード
   - 新規作成：ヘッダー付きで保存
   - 追記：ヘッダーなしで追加

これらの処理により、検出された欠陥候補の詳細な情報が保存され、後続の分析に活用できる形式で出力される。
