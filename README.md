# 4. 加工領域の特定（マスク生成）

## 目的
加工領域（検査対象範囲）を特定し、マスクを生成する。この処理により、後続の欠陥検出処理で必要な領域のみを分析対象とすることができる。

## 処理手順
1. 画像の撮影方向（左右）の判定
2. 適切なテンプレートの選択
3. テンプレートマッチングによる大まかな位置合わせ
4. 位相限定相関による詳細な位置補正
5. マスクの生成と調整

## 関数の詳細説明

### template_matching()
テンプレートマッチングを行う基本関数：

1. 処理内容
   - テンプレート画像の読み込み
   - 正規化相互相関（TM_CCOEFF_NORMED）による類似度計算
   - マッチング位置とスコアの取得

2. 用途
   - 左右判定用テンプレートとのマッチング
   - マスクテンプレートの位置特定

### determine_work_side()
ワークの撮影方向を判定する関数：

1. 処理内容
   - 左右それぞれのテンプレートとマッチング
   - マッチングスコアの比較
   - 高いスコアを示した方向を選択

2. 重要性
   - 適切なマスクテンプレートの選択に必要
   - 後続の位置合わせ処理の基準となる

### get_template_region()
加工部分の位置を特定する関数：

1. 処理内容
   - テンプレートマッチングによる位置検出
   - 領域の座標計算（x1, y1, x2, y2）
   - テンプレートサイズに基づく領域の決定

2. 用途
   - マスク位置補正の基準位置の決定
   - 詳細な位置合わせの準備

### adjust_template_mask()
テンプレートマスクの位置を補正する関数：

1. 処理ステップ
   - テンプレート領域の切り出し
   - 位相限定相関によるズレ量の計算
   - アフィン変換によるマスクの移動
   - 二値化とモルフォロジー処理

2. パラメータ
   - threshold_value：二値化閾値
   - kernel_size：モルフォロジー処理のカーネルサイズ
   - iterations_open/close：処理の繰り返し回数

### create_masks()
画像群に対してマスク生成を実行する関数：

1. 処理フロー
   - 画像ペアの読み込み
   - 撮影方向の判定
   - マスク生成と位置補正
   - 結果の保存

2. 出力データ
   - 生成されたマスク
   - Shape画像
   - ファイル名
   - テンプレート関連情報

### visualize_mask_generation()
マスク生成結果を可視化する関数：

1. 表示内容
   - Shape画像：検査対象の画像
   - テンプレート：使用したマスクテンプレート
   - 調整済みテンプレート：位置補正後
   - 最終マスク：生成されたマスク画像

2. レイアウト
   - 2×2のグリッド表示
   - 画像タイトルと説明
   - 適切なサイズ調整

これらの処理により、欠陥検出のための正確な検査領域を特定することができる。特に、位相限定相関による位置補正により、高精度なマスク生成が実現される。
